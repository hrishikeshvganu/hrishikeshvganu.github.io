<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Building a SOTA Search Ranking System</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Building a SOTA Search Ranking System</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org789272a">Ranking errors on the first page are worse (for the user) than those on later pages</a>
<ul>
<li><a href="#org62f1c79">Capturing this property through ML is not easy</a>
<ul>
<li><a href="#orge3b5402">How to find a proxy metric?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org789272a" class="outline-2">
<h2 id="org789272a">Ranking errors on the first page are worse (for the user) than those on later pages</h2>
<div class="outline-text-2" id="text-org789272a">
<p>
In both cases in the figure, there are 2 products that are ranked incorrectly. The one on left is worse.
</p>

<div class="figure">
<p><img src="img/myimage.png" alt="ranking_diff" title="Action!" align="right" />
</p>
<p><span class="figure-number">Figure 1: </span>All ranking errors are not the same</p>
</div>
</div>

<div id="outline-container-org62f1c79" class="outline-3">
<h3 id="org62f1c79">Capturing this property through ML is not easy</h3>
<div class="outline-text-3" id="text-org62f1c79">
<p>
A loss like NDCG takes into account this consideration.
\[NDCG@k = \sum_{1}^{k}GAIN(i) DISCOUNT(i) \]
Note: I use x&lt;- y  to denote that x depends on y.
</p>
<ul class="org-ul">
<li>DISCOUNT depends on the rank (r).</li>
<li>DISCOUNT&lt;-Rank&lt;- Predicted score (\(S_i\))</li>
<li>\(S_{i}\)&lt;-\(\Theta\) (parameters over which the NDCG can be optimized)</li>
</ul>
<p>
However the rank of a product is a step function of the predicted score.
</p>


<p>
<b>Therefore need to find a proxy that's differentiable and is an upper bound for NDCG or similar losses that matter to business</b>
</p>
</div>

<div id="outline-container-orge3b5402" class="outline-4">
<h4 id="orge3b5402">How to find a proxy metric?</h4>
<div class="outline-text-4" id="text-orge3b5402">
<p>
It's not easy since it's an inverse problem. I'll go into the theory later but I'll be practical and discuss an algorithm called LambdaRank that has been very successful in the real world. I'll provide a hand wavy sketch of how it works (not a proof. There might not be a proof so I'll focus on the emprical)
<a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/02/MSR-TR-2010-82.pdf">LambdaRank and LambdaMART paper</a>
</p>


<div class="figure">
<p><img src="./img/ranking_force.png" alt="ranking_force" title="Action!" align="right" />
</p>
<p><span class="figure-number">Figure 2: </span>Ranking "force" heuristic of LambdaRank</p>
</div>

<p>
\[ \mathrm{Force}_{k,l} = \lambda_{k,l}  \mathrm{Scalefactor}(k,l) \Delta NDCG (k,l) \]
Where $ {Scalefactor}(k,l)$ is a scaling factor from 0 to 1. This factor is larger if the difference in scores of \(k\) and \(l\) is large and negative. \(\Delta NDCG (k,l)\) is the change in NDCG if the product positons are swapped.
</p>
<ul class="org-ul">
<li>The "force" is used as the residual (gradient of the training loss) that has to be optimized through iterations of gradient boosting.</li>
<li>Thus a pair of products in mutually incorrect order gets a higher penalty if the difference in current scores is large and negative.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
